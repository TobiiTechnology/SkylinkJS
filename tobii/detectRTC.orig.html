
<html><head><meta name="version" content="0.1.1"><script>
    // Originally developed by Muaz Khan under MIT license
    // https://github.com/muaz-khan/WebRTC-Experiment/tree/master/DetectRTC
    var DetectRTC = {};

    var screenCallback;
    var extensionInstalledCallback;

    DetectRTC.screen = {
        chromeMediaSource: 'screen',
        getSourceId: function(callback) {
            screenCallback = callback;
            window.postMessage('get-sourceId', '*');
        },
        onMessageCallback: function(data) {
            // "cancel" button is clicked
            if (data === 'PermissionDeniedError') {
                DetectRTC.screen.chromeMediaSource = 'PermissionDeniedError';
                if (screenCallback) return screenCallback('PermissionDeniedError');
                else throw new Error('PermissionDeniedError');
            }

            // extension notified his presence
            if (data === 'rtcmulticonnection-extension-loaded') {
                DetectRTC.screen.chromeMediaSource = 'desktop';

                if (typeof extensionInstalledCallback === 'function') {
                    extensionInstalledCallback();
                }
            }

            // extension shared temp sourceId
            if (data.sourceId) {
                DetectRTC.screen.sourceId = data.sourceId;
                if (screenCallback) screenCallback(DetectRTC.screen.sourceId);
            }
        },
        getChromeExtensionStatus: function(callback, customExtensionId) {
            var extensionid = 'ljckddiekopnnjoeaiofddfhgnbdoafc',
                    extensionInstalledTimeout = null,
                    checkTerminated = false;

            extensionInstalledCallback = function () {
                if (checkTerminated) {
                    return;
                }

                if (extensionInstalledTimeout) {
                    clearTimeout(extensionInstalledTimeout);
                }

                callback('installed-enabled');
            };

            if (customExtensionId) {
                extensionid = customExtensionId;
            }

            var image = document.createElement('img');
            image.src = 'chrome-extension://' + extensionid + '/icon.png';
            image.onload = function() {
                DetectRTC.screen.chromeMediaSource = 'screen';
                window.postMessage('are-you-there', '*');
                extensionInstalledTimeout = setTimeout(function() {
                    if (checkTerminated) {
                        return;
                    }

                    if (DetectRTC.screen.chromeMediaSource == 'screen') {
                        checkTerminated = true;

                        callback('installed-disabled');
                    }
                    // Set your preferred timeout here by manipulating the [2500] value
                }, 2500);
            };
            image.onerror = function() {
                callback('not-installed', 'https://chrome.google.com/webstore/detail/skylink-webrtc-tools/' + extensionid);
            };
        }
    };

    window.addEventListener('message', function(event) {
        if (!event.data || !(typeof event.data == 'string' || event.data.sourceId || event.data.captureSourceId || event.data.mozConstraints)) return;
        if (event.data.captureSourceId) captureSourceId(event.data.extensionId);
        if (event.data.mozConstraints) getSource(event.data.mozConstraints);

        DetectRTC.screen.onMessageCallback(event.data);
    });

    function captureSourceId(extensionId) {
        // check if desktop-capture extension installed.
        DetectRTC.screen.getChromeExtensionStatus(function(status, data) {
            if (status != 'installed-enabled') {
                window.parent.postMessage({
                    chromeExtensionStatus: status,
                    data: data
                }, '*');
                return;
            }

            DetectRTC.screen.getSourceId(function(sourceId) {
                window.parent.postMessage({
                    chromeMediaSourceId: sourceId
                }, '*');
            });
        }, extensionId);
    }
</script>
</head><body></body></html>
