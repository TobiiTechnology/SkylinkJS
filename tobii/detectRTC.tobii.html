
<!-- saved from url=(0060)https://cdn.temasys.com.sg/skylink/extensions/detectRTC.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><script>
// Originally developed by Muaz Khan under MIT license
// https://github.com/muaz-khan/WebRTC-Experiment/tree/master/DetectRTC
var DetectRTC = {};

var screenCallback;

DetectRTC.screen = {
    chromeMediaSource: 'screen',
    getSourceId: function (callback) {
        screenCallback = callback;
        window.postMessage('get-sourceId', '*');
    },
    onMessageCallback: function (data) {
        // "cancel" button is clicked
        if (data === 'PermissionDeniedError') {
            DetectRTC.screen.chromeMediaSource = 'PermissionDeniedError';
            if (screenCallback) return screenCallback('PermissionDeniedError');
            else throw new Error('PermissionDeniedError');
        }

        // extension notified his presence
        if (data === 'rtcmulticonnection-extension-loaded') {
            DetectRTC.screen.chromeMediaSource = 'desktop';
        }

        // extension shared temp sourceId
        if (data.sourceId) {
            DetectRTC.screen.sourceId = data.sourceId;
            if (screenCallback) screenCallback(DetectRTC.screen.sourceId);
        }
    },
    getChromeExtensionStatus: function (callback) {
        var extensionid = 'oiagokmfmoljcemmpobhbaimkjjkigcd';

        var image = document.createElement('img');
        image.src = 'chrome-extension://' + extensionid + '/icon.png';
        image.onload = function () {
            DetectRTC.screen.chromeMediaSource = 'screen';
            window.postMessage('are-you-there', '*');
            setTimeout(function () {
                if (DetectRTC.screen.chromeMediaSource == 'screen') {
                    callback('installed-disabled');
                } else callback('installed-enabled');
            }, 2000);
        };
        image.onerror = function () {
            callback('not-installed', 'https://chrome.google.com/webstore/detail/tobii-pro-webrtc-extensio/' + extensionid);
        };
    }
};

window.addEventListener('message', function (event) {

    if (!event.data || !(typeof event.data == 'string' || event.data.sourceId || event.data.captureSourceId ||
      event.data.mozConstraints)) return;
    if (event.data.captureSourceId) captureSourceId();
    if (event.data.mozConstraints) getSource(event.data.mozConstraints);

    DetectRTC.screen.onMessageCallback(event.data);
});

function captureSourceId() {
    // check if desktop-capture extension installed.
    DetectRTC.screen.getChromeExtensionStatus(function (status, data) {
        if (status != 'installed-enabled') {
            window.parent.postMessage({
                chromeExtensionStatus: status,
                data: data
            }, '*');
            return;
        }

        DetectRTC.screen.getSourceId(function (sourceId) {
            window.parent.postMessage({
                chromeMediaSourceId: sourceId
            }, '*');
        });
    });
}

function getSource(mozConstraints) {

  var successCb = function (stream) {
    window.parent.AdapterJS.screensharingCallback(null, stream);
  };

  var failureCb = function (error) {
    if (error.name === 'PermissionDeniedError' && window.parent.location.protocol === 'https:') {
      window.location.href = 'https://cdn.temasys.com.sg/skylink/extensions/skylink-webrtc-tools.xpi';
    } else {
      window.parent.AdapterJS.screensharingCallback(error, null);
    }
  };

  try {
    window.navigator.mozGetUserMedia(mozConstraints, successCb, failureCb);
  } catch (error) {
    failureCb(error);
  }
}
</script>
</head><body>
</body></html>